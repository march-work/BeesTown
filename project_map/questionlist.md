# BeesTown 架构澄清问题清单（基于 MAIN_ARCHITECTURE.md）

> 目的：把当前主架构中“方向清楚但实现落地需要拍板”的点，整理成可逐条回答的问题。

> 状态标记：✅ 已拍板 / 🟡 待拍板（关键但未定） / 🔍 待澄清（需要补充约束或例子）

## 1. 边界与总览

1. ✅ `BeesTownProject` 的语义定位是什么？  
   - 已明确：BeesTown 是面向多 Agent 协作的 CLI 编辑器类工具；项目用于从零创建或进入维护既有项目；“公司/部门/员工”是交互隐喻  
   - ✅ 已拍板：CLI 以“当前打开的目录”为项目作用域；项目相关的配置/记忆/技能等数据都落在该目录下的 `.bees/` 子目录中  
   - 🔍 例外：允许使用绝对路径访问项目目录外的文件，但项目级数据（配置、记忆、技能等）仍只写入当前项目目录的 `.bees/`
2. ✅ 系统是否以“单用户本地 CLI”为优先目标？是否支持“多用户共享同一公司/项目”？  
   - 已拍板：只支持**单人类用户（单操作者）**

3. ✅ “公司级共享资源”与“部门共享资源”的关系如何定义？  
   - 已明确：每个 Agent 基于 `level` 与 `department` 继承工具/技能等资源；资源本身也声明适用范围（例如仅对 `level=X`、`department=X` 生效）  
   - 已拍板（推荐方案）：公司级共享资源实现为一个特殊的 `level=0` 部门，以统一继承链路：公司级（level=0）→ 部门 → 个人；最终对某个 Agent 的可用资源还需再按资源的适用范围过滤

## 2. 入口（HR）职责边界

1. ✅ 命令路由是否必须全部经过 HR？  
   - 已拍板：输入若为工具命令（明确、结构化的 CLI 命令/子命令），则不走 HR，直接交给对应命令处理器执行（传统命令行风格，稳定可预测、可脚本化）；输入若为自然语言需求（NL），才经 HR 进行需求理解、拆解、推荐/编排与审批
2. ✅ CLI 如何判定输入属于“工具命令”还是“自然语言”？（参考 Claude Code / Qwen CLI 风格）  
   - 已拍板：优先按“可解析为已注册子命令/工具调用”的结构化输入走工具命令通道；否则当作自然语言交给 HR  
   - 建议规则：命中子命令前缀/别名即判定为工具命令；若解析失败或存在歧义则 fallback 为 NL（避免误执行）
3. ✅ HR 的“需求理解/团队推荐”是模板/规则驱动、LLM 驱动，还是混合？  
   - 已拍板：混合（规则/约束兜底 + LLM 做理解与拆解）
4. ✅ 若混合：优先级怎么定？如何保证推荐理由可解释？  
   - 已拍板：以“任务拆解 + 资源/上下文约束”作为可解释的硬规则，LLM 只在规则空间内生成方案  
   - 约束（用于推导需要多少工人 Agent）：  
     - 选取互不干涉的任务分解并并行分配  
     - 单个工人（如前端）todolist 最多 5 个  
     - 单个 Agent 的上下文 + 本次输入不超过 150K  
     - 单个 Agent 的 ReAct 次数控制在 8–12 次  
     - 若项目经理规划超过以上限制，则需要增加更多工人 Agent  
   - 协作机制：HR 需要与项目经理 Agent 沟通任务与人员需求，完成人员规划

## 3. 组织架构与汇报链

1. `reportsTo` / `subordinates` 是否允许跨部门？若允许，是否要求存在共同上级或指定接口人？
2. 部门 `level` 与 Agent `level` 是两套不同维度：各自含义分别是什么？（管理层级/组织树深度/权限等级等）
3. “紧急通道（跳过中间层级）”触发条件是什么？由谁有权触发？（用户、HR、负责人、系统规则）

## 4. 任务系统（落地细节待拍板）

1. 任务是否是一个持久化对象？如果是，任务的最小字段集合是什么？（目标、验收标准、owner、状态、依赖、产物链接等）
2. 任务执行模型是串行对话驱动，还是支持并发/队列？
3. 若并发：冲突如何处理？（例如两个 Agent 同时改同一文件、同一 PRD）
4. “汇报”是强制结构化（固定 schema），还是自由文本为主？CLI 默认展示哪一种更符合你预期？

## 5. 记忆系统（分层与存储策略）

1. 最终认可的记忆层级数是多少：3 层（个人/部门/公司）还是 4 层（额外 HR 跨项目层）？HR 记忆是否属于系统层而非公司层？
2. “向量数据库（短期记忆）+ SQLite（长期记忆）”的划分：向量库具体存什么？（近期对话片段、知识条目 embedding、文件片段 embedding 等）SQLite 具体存什么？（事件日志/任务/索引等）
3. 资源冲突解决规则中，“技能同名参数合并”希望满足哪些性质？（可交换/幂等/可解释）
4. 示例：部门技能 `React@18`，个人技能 `React@19`，合并结果应该是覆盖/并存/报错/取最新，还是其他规则？

## 6. Tools / Skills / MCP 的权限与审计

1. 最小权限模型怎么选：按部门、按角色、按个人、按任务临时授权，还是组合？
2. 主架构是否需要提前写明“安全基线”？例如：默认只允许在项目目录内读写；危险命令二次确认；所有变更写审计日志。
3. 你倾向默认策略是什么：默认安全（限制多、显式放权）还是默认强力可用（限制少、必要时审计兜底）？
4. ✅ 分级审批链路怎么定义？  
   - 已明确：LV0=人类；LV1=HR/项目管理工具调用需人类批准；LV2+ 下级工具调用需上级批准，无需直接请求人类  
   - 🔍 待澄清：如何判定“上级”与“批准者”？（`reportsTo` 为准？部门 head？任务 owner？紧急通道如何影响审批）
5. 🟡 待拍板：工具按风险如何分级？哪些默认永远需要 LV0？哪些允许 LV1/LV2+ 自主？是否支持白名单/额度/范围限制（例如仅限项目目录内写入）？

## 7. LLM Provider：网关、成本与可复现性

1. LLM 接入是集中式网关（统一限流/缓存/日志/成本统计）还是各 Agent 直连 provider？
2. 是否需要“可复现/可回放模式”？若需要，哪些数据必须持久化？（prompt、模型版本、temperature、工具调用记录等）

## 8. 插件系统与模板（扩展点契约）

1. `enhanceHR` 的扩展方式是链式 middleware 还是整体替换？
2. 多插件同时增强 HR 时，执行顺序与冲突策略怎么定？
3. 角色模板是否包含默认工具/技能/记忆种子/系统提示词？如果包含，与部门共享资源的继承优先级如何叠加？

## 9. 建议优先拍板的 6 个问题（MVP 主干）

1. 项目实体到底落在哪种存储/目录模型上？
2. ✅ 命令是否必须经过 HR？已拍板为“工具命令直达、NL 经 HR”
3. 任务对象最小 schema 是什么、是否并发？
4. 记忆层级是 3 层还是 4 层、向量库/SQLite 各存什么？
5. 工具/MCP 的最小权限与审计基线是什么？
6. LLM 走集中网关还是各自直连？
